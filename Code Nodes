try {
  // à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ input
  const input = $input.first().json;
  
  // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š format à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š
  console.log('ðŸ“¡ Full input data:', JSON.stringify(input, null, 2));
  
  // à¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸ message field (à¸—à¸µà¹ˆ MQTT à¸ªà¹ˆà¸‡à¸¡à¸²)
  const rawValue = input.message || input.payload || input.value || 0;
  const topic = input.topic || 'data/qwCOowlTnOYNSLVmZVMW/1'; // default à¹€à¸›à¹‡à¸™à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´
  const timestamp = new Date().toLocaleString('th-TH');
  
  console.log('ðŸ“Š Raw value from MQTT:', rawValue);
  console.log('ðŸ“¡ Topic:', topic);
  
  // à¹à¸›à¸¥à¸‡à¸„à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚
  let value = 0;
  if (rawValue !== null && rawValue !== undefined && rawValue !== '') {
    const parsedValue = parseFloat(rawValue);
    if (!isNaN(parsedValue)) {
      value = parsedValue;
      console.log('âœ… Parsed value:', value);
    } else {
      console.log('âš ï¸ Cannot parse to number:', rawValue);
    }
  }
  
  // à¹à¸¢à¸à¸›à¸£à¸°à¹€à¸ à¸— sensor à¸ˆà¸²à¸ topic à¸«à¸£à¸·à¸­à¸„à¸²à¸”à¹€à¸”à¸²à¸ˆà¸²à¸à¸„à¹ˆà¸²
  const topicParts = topic.split('/');
  const deviceKey = topicParts[1] || 'qwCOowlTnOYNSLVmZVMW';
  let slot = topicParts[2] || '1'; // default à¹€à¸›à¹‡à¸™ slot 1 (à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´)
  
  // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ topic à¹ƒà¸«à¹‰à¹€à¸”à¸²à¸ˆà¸²à¸à¸Šà¹ˆà¸§à¸‡à¸„à¹ˆà¸²
  if (!input.topic) {
    if (value >= 0 && value <= 50) {
      slot = '1'; // à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´
      console.log('ðŸ” à¹„à¸¡à¹ˆà¸¡à¸µ topic, à¹€à¸”à¸²à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´ (0-50Â°C)');
    } else if (value > 50 && value <= 100) {
      slot = '2'; // à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™
      console.log('ðŸ” à¹„à¸¡à¹ˆà¸¡à¸µ topic, à¹€à¸”à¸²à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™ (50-100%)');
    }
  }
  
  let sensorName = 'Unknown Sensor';
  let sensorType = 'unknown';
  let unit = '';
  let icon = 'ðŸ“Š';
  let assessment = 'à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸š';
  
  // à¸à¸³à¸«à¸™à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ sensor à¸•à¸²à¸¡ slot
  switch(slot) {
    case '1':
      sensorName = 'à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´';
      sensorType = 'temperature';
      unit = 'Â°C';
      icon = 'ðŸŒ¡ï¸';
      if (value < 16) assessment = 'à¹€à¸¢à¹‡à¸™à¸¡à¸²à¸';
      else if (value < 20) assessment = 'à¹€à¸¢à¹‡à¸™';
      else if (value < 25) assessment = 'à¸ªà¸šà¸²à¸¢';
      else if (value < 30) assessment = 'à¸­à¸šà¸­à¸¸à¹ˆà¸™';
      else if (value < 35) assessment = 'à¸£à¹‰à¸­à¸™';
      else assessment = 'à¸£à¹‰à¸­à¸™à¸¡à¸²à¸';
      break;
      
    case '2':
      sensorName = 'à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™';
      sensorType = 'humidity';
      unit = '%';
      icon = 'ðŸ’§';
      if (value < 30) assessment = 'à¹à¸«à¹‰à¸‡à¸¡à¸²à¸';
      else if (value < 40) assessment = 'à¹à¸«à¹‰à¸‡';
      else if (value < 60) assessment = 'à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡';
      else if (value < 80) assessment = 'à¸Šà¸·à¹‰à¸™';
      else assessment = 'à¸Šà¸·à¹‰à¸™à¸¡à¸²à¸';
      break;
      
    default:
      sensorName = `Sensor à¸Šà¹ˆà¸­à¸‡ ${slot}`;
      sensorType = 'unknown';
  }
  
  // à¹à¸ªà¸”à¸‡à¸œà¸¥à¹ƒà¸™ console
  console.log(`${icon} à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥: ${sensorName}`);
  console.log(`ðŸ“Š à¸„à¹ˆà¸²: ${value}${unit} (${assessment})`);
  console.log(`ðŸ“¡ Device: ${deviceKey}`);
  console.log(`ðŸ• à¹€à¸§à¸¥à¸²: ${timestamp}`);
  
  // à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ªà¸³à¸«à¸£à¸±à¸š AI
  const message = `${icon} à¹„à¸”à¹‰à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥${sensorName}à¹ƒà¸«à¸¡à¹ˆ!

ðŸ“Š à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”:
- ${sensorName}: ${value}${unit}
- à¸›à¸£à¸°à¹€à¸¡à¸´à¸™à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™: ${assessment}
- à¹€à¸§à¸¥à¸²: ${timestamp}
- à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ: ${deviceKey}

à¹‚à¸›à¸£à¸”à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸¡à¸¹à¸¥${sensorName} ${value}${unit} à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¹€à¸«à¹‡à¸™:
1. à¸„à¹ˆà¸²à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£ (à¸›à¸à¸•à¸´/à¸ªà¸¹à¸‡/à¸•à¹ˆà¸³)
2. à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸ à¸²à¸žà¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
3. à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡
4. à¸œà¸¥à¸à¸£à¸°à¸—à¸šà¸•à¹ˆà¸­à¸ªà¸¸à¸‚à¸ à¸²à¸ž

à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹à¸šà¸šà¸à¸£à¸°à¸Šà¸±à¸š`;

  // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸› AI Agent
  return [{
    json: {
      message: message,
      sensor_data: {
        name: sensorName,
        type: sensorType,
        value: value, // à¸„à¹ˆà¸²à¸—à¸µà¹ˆà¹à¸›à¸¥à¸‡à¹à¸¥à¹‰à¸§
        unit: unit,
        icon: icon,
        slot: slot,
        assessment: assessment,
        timestamp: timestamp,
        topic: topic,
        device_key: deviceKey
      },
      debug_info: {
        raw_input: input,
        raw_value: rawValue,
        parsed_value: value,
        topic_detected: topic,
        slot_detected: slot
      },
      processing_info: {
        success: true,
        processed_at: new Date().toISOString()
      }
    }
  }];
  
} catch (error) {
  console.log('âŒ Error in Code node:', error.message);
  
  return [{
    json: {
      message: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸‚à¹‰à¸­à¸¡à¸¹à¸¥",
      sensor_data: {
        name: "Error",
        type: "error",
        value: 0,
        unit: "",
        icon: "âŒ",
        slot: "0",
        assessment: "à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”",
        timestamp: new Date().toLocaleString('th-TH'),
        topic: "error",
        device_key: "unknown"
      },
      error_info: {
        error_message: error.message,
        input_received: $input.first().json
      }
    }
  }];
}
